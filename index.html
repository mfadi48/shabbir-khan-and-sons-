<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK & Sons | Advanced ERP & Tax Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --navy: #002147; --gold: #ffcc00; --green: #2ecc71; --red: #e74c3c; --gray: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--gray); margin: 0; color: #333; }
        header { background: var(--navy); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px 5%; max-width: 1400px; margin: auto; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card h4 { margin: 0; font-size: 0.85rem; text-transform: uppercase; color: #777; }
        .card h2 { margin: 10px 0 0; font-size: 1.6rem; color: var(--navy); }

        /* Main Grid */
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .form-box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        
        label { display: block; margin: 10px 0 5px; font-weight: bold; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 5px; }
        
        .tax-section { background: #fffde7; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #ffe082; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        
        /* Report Table */
        .report-box { background: white; padding: 20px; border-radius: 15px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid var(--navy); font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-credit { background: #fff3e0; color: #ef6c00; }
        .badge-cash { background: #e8f5e9; color: #2e7d32; }

        @media (max-width: 1000px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div><strong>SHABBIR KHAN & SONS</strong> | ERP SYSTEM</div>
    <div id="clock"></div>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="card"><h4>Monthly Profit</h4><h2 id="mProfit">Rs. 0</h2></div>
        <div class="card"><h4>Receivable (Credit)</h4><h2 id="mCredit" style="color:var(--red)">Rs. 0</h2></div>
        <div class="card"><h4>Diesel Consumption</h4><h2 id="mDiesel">0 Liters</h2></div>
        <div class="card"><h4>Best Vehicle</h4><h2 id="mBest">N/A</h2></div>
    </div>

    <div class="main-layout">
        <div class="form-box">
            <h3 style="margin-top:0">New Entry</h3>
            <label>Trip Date</label>
            <input type="date" id="date">
            <label>Vehicle No.</label>
            <input type="text" id="truck" placeholder="e.g. LES-1234">
            <label>Party / Company</label>
            <input type="text" id="party" placeholder="e.g. Lucky Cement">
            <label>Freight (Gross)</label>
            <input type="number" id="freight" placeholder="Total Bhara">
            
            <div class="tax-section">
                <label>Tax Settings</label>
                <select id="taxType" onchange="calcTotal()">
                    <option value="none">No Tax</option>
                    <option value="sales">Sales Tax (18%)</option>
                    <option value="income">WHT Income Tax (3%)</option>
                    <option value="both">Both Taxes</option>
                </select>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    Tax Amount: <span id="taxDisplay">0</span>
                </div>
            </div>

            <label>Payment Method</label>
            <select id="payment">
                <option value="Cash">Cash</option>
                <option value="Credit">Credit (Pay Later)</option>
            </select>

            <label>Diesel (Rs.)</label>
            <input type="number" id="diesel" placeholder="Diesel Kharcha">
            <label>Misc. Exp (Toll/Driver)</label>
            <input type="number" id="misc" placeholder="Other expenses">

            <button class="btn-action" style="background:var(--navy)" onclick="addTrip()">SAVE & GENERATE INVOICE</button>
        </div>

        <div class="report-box">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>Trip Ledger & Performance</h3>
                <button onclick="exportData()" style="padding:5px 10px; cursor:pointer;">Export Excel</button>
            </div>
            <table id="tripTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Truck</th>
                        <th>Party</th>
                        <th>Total Bhara</th>
                        <th>Diesel</th>
                        <th>Net Profit</th>
                        <th>Payment</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('sk_erp_trips')) || [];

    function calcTotal() {
        let f = Number(document.getElementById('freight').value);
        let type = document.getElementById('taxType').value;
        let tax = 0;
        if(type === 'sales') tax = f * 0.18;
        if(type === 'income') tax = f * 0.03;
        if(type === 'both') tax = f * 0.21;
        document.getElementById('taxDisplay').innerText = tax.toFixed(0);
    }

    function addTrip() {
        const trip = {
            id: Date.now(),
            date: document.getElementById('date').value,
            truck: document.getElementById('truck').value.toUpperCase(),
            party: document.getElementById('party').value,
            freight: Number(document.getElementById('freight').value),
            tax: Number(document.getElementById('taxDisplay').innerText),
            payment: document.getElementById('payment').value,
            diesel: Number(document.getElementById('diesel').value),
            misc: Number(document.getElementById('misc').value)
        };

        if(!trip.date || !trip.freight) return alert("Fill mandatory fields!");
        
        trips.unshift(trip);
        saveAndRender();
        generatePDF(trip);
    }

    function saveAndRender() {
        localStorage.setItem('sk_erp_trips', JSON.stringify(trips));
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        
        let tProfit = 0, tCredit = 0, tDiesel = 0;
        let vehicleStats = {};

        trips.forEach(t => {
            let totalExp = t.diesel + t.misc;
            let net = t.freight - t.tax - totalExp;
            
            tProfit += net;
            tDiesel += t.diesel;
            if(t.payment === 'Credit') tCredit += (t.freight - t.tax);
            
            // Track vehicle performance
            vehicleStats[t.truck] = (vehicleStats[t.truck] || 0) + net;

            body.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td><strong>${t.truck}</strong></td>
                    <td>${t.party}</td>
                    <td>Rs. ${t.freight}</td>
                    <td>Rs. ${t.diesel}</td>
                    <td style="color:${net > 0 ? 'green':'red'}">Rs. ${net}</td>
                    <td><span class="badge badge-${t.payment.toLowerCase()}">${t.payment}</span></td>
                </tr>
            `;
        });

        document.getElementById('mProfit').innerText = "Rs. " + tProfit.toLocaleString();
        document.getElementById('mCredit').innerText = "Rs. " + tCredit.toLocaleString();
        document.getElementById('mDiesel').innerText = (tDiesel/280).toFixed(0) + " Liters (Approx)";
        
        // Find best vehicle
        let bestV = Object.keys(vehicleStats).reduce((a, b) => vehicleStats[a] > vehicleStats[b] ? a : b, "N/A");
        document.getElementById('mBest').innerText = bestV;
    }

    function generatePDF(t) {
        alert("Invoice Generated for " + t.party + "\nOrder ID: SK-" + t.id.toString().slice(-4));
        // Note: Real PDF generation usually requires a library like jspdf. 
        // For now, it shows the data confirmation.
    }

    function exportData() {
        let csv = "Date,Truck,Party,Freight,Tax,Diesel,Misc,Payment\n";
        trips.forEach(t => {
            csv += `${t.date},${t.truck},${t.party},${t.freight},${t.tax},${t.diesel},${t.misc},${t.payment}\n`;
        });
        let blob = new Blob([csv], { type: 'text/csv' });
        let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'sk_transport_report.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    saveAndRender();
</script>

</body>
</html>
